/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Http, Headers } from '@angular/http';
import { map, retry } from 'rxjs/operators';
import { BehaviorSubject } from 'rxjs';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/http';
export class FlxUiDatatableService {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
        this.dataUrl = '';
        this.behavior = new BehaviorSubject([]);
        this.flxData = this.behavior.asObservable();
        this.pagination = [];
        this.totalItems = 0;
        this.dataOffset = 0;
        this.limit = 20;
        this.dataSrcKey = '';
        //Hold items selected for multiple select
        this.multipleDeletion = [];
        //Keep track if API call is completed
        this.loadFinish = false;
        this.lazyloadingConfig = {};
        this.processedData = {};
    }
    /**
     * @param {?} config
     * @return {?}
     */
    setLazyloadingConfig(config) {
        this.lazyloadingConfig = config;
    }
    /**
     *
     * @param {?} url User api rul
     * @return {?}
     */
    getData(url) {
        let /** @type {?} */ headers = new Headers();
        headers.append('Content-Type', 'application/x-www-form-urlencoded');
        return this.http.get(url, { headers: headers }).pipe(retry(5), map((response) => response.json()));
    }
    /**
     *
     * @param {?} url Service api url
     * @param {?} id Datatype id to export
     * @param {?} data Data to export
     * @return {?}
     */
    postData(url, id, data) {
        let /** @type {?} */ headers = new Headers();
        headers.append('Content-Type', 'application/json; charset=utf-8');
        return this.http.post(url + id, data, { headers: headers }).pipe(map((resp) => resp.json()));
    }
    /**
     *
     * @param {?} dataUrl Set dataurl
     * @return {?}
     */
    setDataUrl(dataUrl) {
        this.dataUrl = dataUrl;
    }
    /**
     * @return {?}
     */
    getDataUrl() {
        return this.dataUrl;
    }
    /**
     *
     * @param {?} data Register new data from user API
     * @return {?}
     */
    chageDataTable(data) {
        this.behavior.next(data);
    }
    /**
     *
     * @param {?} numberOfList Total number of list
     * @param {?} limit Pagination limit
     * @return {?}
     */
    createPagination(numberOfList, limit) {
        let /** @type {?} */ obj = [];
        let /** @type {?} */ counter = 1;
        for (let /** @type {?} */ i = 0; i < numberOfList; i += limit) {
            obj.push({ label: counter, value: i });
            counter++;
        }
        if (!this.isLazyLoadingEnabled) {
            obj.push({ label: 'All', value: 'all' });
        }
        return obj;
    }
    /**
     * @return {?}
     */
    isLazyLoadingEnabled() {
        return this.lazyloadingConfig.hasOwnProperty("apiOffsetKey") && this.lazyloadingConfig.apiOffsetKey;
    }
    /**
     * @param {?} dataUrl
     * @param {?=} setSelectPagination
     * @return {?}
     */
    loadFlxDataTableData(dataUrl, setSelectPagination = true) {
        this.loadFinish = false;
        this.loader = this.getData(dataUrl).subscribe((responseData) => {
            try {
                this.multipleDeletion = [];
                var /** @type {?} */ data = (this.dataSrcKey) ? responseData[this.dataSrcKey] : responseData;
                this.chageDataTable(data);
                if (this.isLazyLoadingEnabled()) {
                    this.totalItems = responseData.total;
                    // Handle 1 pagination out of zero problem 1/0  instead of 0/0 if no data is comming
                    if (data.length > 0) {
                        this.dataOffset = this.dataOffset + this.limit;
                    }
                }
                else {
                    this.totalItems = data.length;
                    this.dataOffset = 1;
                }
                if (setSelectPagination) {
                    if (this.isLazyLoadingEnabled()) {
                        this.pagination = this.createPagination(responseData.total, this.limit);
                    }
                    else {
                        this.pagination = this.createPagination(data.length, this.limit);
                    }
                }
                this.loadFinish = true;
            }
            catch (/** @type {?} */ e) {
                console.log('Error in reading data in ', e);
            }
        }, (e => {
            this.loadFinish = true;
        }));
    }
    /**
     * @return {?}
     */
    cancelLoading() {
        this.loader.unsubscribe();
    }
    /**
     * @param {?} srcKey
     * @return {?}
     */
    setDataSrcKey(srcKey) {
        this.dataSrcKey = srcKey;
    }
    /**
     * @return {?}
     */
    getDataLength() {
        return new Promise((resolve) => {
            this.flxData.subscribe((resp) => {
                resolve(resp.length);
            }, (e => {
                resolve(0);
            }));
        });
    }
}
FlxUiDatatableService.ɵfac = function FlxUiDatatableService_Factory(t) { return new (t || FlxUiDatatableService)(ɵngcc0.ɵɵinject(ɵngcc1.Http)); };
FlxUiDatatableService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: FlxUiDatatableService, factory: FlxUiDatatableService.ɵfac });
/** @nocollapse */
FlxUiDatatableService.ctorParameters = () => [
    { type: Http }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(FlxUiDatatableService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.Http }]; }, null); })();
function FlxUiDatatableService_tsickle_Closure_declarations() {
    /** @type {?} */
    FlxUiDatatableService.prototype.dataUrl;
    /** @type {?} */
    FlxUiDatatableService.prototype.behavior;
    /** @type {?} */
    FlxUiDatatableService.prototype.flxData;
    /** @type {?} */
    FlxUiDatatableService.prototype.pagination;
    /** @type {?} */
    FlxUiDatatableService.prototype.totalItems;
    /** @type {?} */
    FlxUiDatatableService.prototype.dataOffset;
    /** @type {?} */
    FlxUiDatatableService.prototype.limit;
    /** @type {?} */
    FlxUiDatatableService.prototype.dataSrcKey;
    /** @type {?} */
    FlxUiDatatableService.prototype.multipleDeletion;
    /** @type {?} */
    FlxUiDatatableService.prototype.loader;
    /** @type {?} */
    FlxUiDatatableService.prototype.loadFinish;
    /** @type {?} */
    FlxUiDatatableService.prototype.lazyloadingConfig;
    /** @type {?} */
    FlxUiDatatableService.prototype.processedData;
    /** @type {?} */
    FlxUiDatatableService.prototype.http;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmx4LXVpLWRhdGF0YWJsZS5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyJuZzovZmx4LXVpLWRhdGF0YWJsZS9saWIvZmx4LXVpLWRhdGF0YWJsZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFFO0FBQzVDLE9BQU8sRUFBRSxJQUFJLEVBQUMsT0FBTyxFQUFVLE1BQU0sZUFBZSxDQUFFO0FBQ3RELE9BQU8sRUFBRSxHQUFHLEVBQUMsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUU7QUFDNUMsT0FBTyxFQUFrQixlQUFlLEVBQWUsTUFBTSxNQUFNLENBQUM7OztBQUVwRSxNQUFNOzs7O0lBeUJKLFlBQW1CLElBQVU7UUFBVixTQUFJLEdBQUosSUFBSSxDQUFNO3VCQXZCSCxFQUFFO3dCQUNZLElBQUksZUFBZSxDQUFNLEVBQUUsQ0FBQzt1QkFFbkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUU7MEJBRVYsRUFBRTswQkFFVCxDQUFDOzBCQUVELENBQUM7cUJBRU4sRUFBRTswQkFFRSxFQUFFOztnQ0FFQyxFQUFFOzswQkFJVixLQUFLO2lDQUVNLEVBQUU7NkJBQ1AsRUFBRTtLQUc3Qjs7Ozs7SUFFTSxvQkFBb0IsQ0FBQyxNQUFVO1FBQ3BDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxNQUFNLENBQUU7Ozs7Ozs7SUFRNUIsT0FBTyxDQUFDLEdBQVU7UUFDckIscUJBQUksT0FBTyxHQUFZLElBQUksT0FBTyxFQUFFLENBQUU7UUFDdEMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUMsbUNBQW1DLENBQUMsQ0FBRTtRQUNwRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFDLEVBQUMsT0FBTyxFQUFDLE9BQU8sRUFBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBQyxHQUFHLENBQUMsQ0FB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LElBQUksRUFBRSxFQUFFO2dCQUM5QixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFFO2FBQ3ZCLEVBQUMsQ0FBQyxDQUFDLENBQUEsRUFBRTtnQkFDSixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUU7YUFDYixDQUFDLENBQUMsQ0FBQTtTQUNKLENBQUMsQ0FBRTtLQUNMOzs7Q0FDRixrREExSkEsVUFBVSxrRUFDUjs7O1lBSk0sSUFBSTs7OztxRUFBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJyA7XG5pbXBvcnQgeyBIdHRwLEhlYWRlcnMsUmVzcG9uc2V9IGZyb20gJ0Bhbmd1bGFyL2h0dHAnIDtcbmltcG9ydCB7IG1hcCxyZXRyeSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJyA7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLHBpcGUsQmVoYXZpb3JTdWJqZWN0LFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEZseFVpRGF0YXRhYmxlU2VydmljZXtcbiAgLy9Vc2VyIGRhdGEgQVBJIHVybFxuICBwcml2YXRlIGRhdGFVcmw6IHN0cmluZyA9ICcnIDtcbiAgcHVibGljIGJlaGF2aW9yOiBCZWhhdmlvclN1YmplY3Q8YW55PiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8YW55PihbXSkgO1xuICAvL0hvbGQgYWxsIGRhdGEgZnJvbSBBUElcbiAgcHVibGljIGZseERhdGEgPSB0aGlzLmJlaGF2aW9yLmFzT2JzZXJ2YWJsZSgpOyAgXG4gIC8vSGVhZGVyIHNlbGVjdCBwYWdpbmF0aW9uXG4gIHB1YmxpYyBwYWdpbmF0aW9uOiBBcnJheTxPYmplY3Q+ID0gW10gO1xuICAvL0hvbGQgdG90YWwgaXRlbXMgbG9hZGVkIGZyb20gQVBJXG4gIHB1YmxpYyB0b3RhbEl0ZW1zOiBudW1iZXIgPSAwIDtcbiAgLy9LZWVwIHRyYWNrIG9mIGN1cnJlbnQgcGFnaW5hdGlvbiBvZmZzZXRcbiAgcHVibGljIGRhdGFPZmZzZXQ6IG51bWJlciA9IDAgO1xuICAvL1VzZXIgZGVmaW5lZCBsaW1pdCBmb3IgbnVtYmVyIG9mIGl0ZW1zIHBlciBwYWdpbmF0aW9uXG4gIHB1YmxpYyBsaW1pdDogbnVtYmVyID0gMjAgO1xuICAvL0RhdGEgc291cmNlIGtleSB0byByZWFkIGZyb20gQVBJIHBheWxvYWQgcmVzcG9uc2VcbiAgcHVibGljIGRhdGFTcmNLZXk6c3RyaW5nID0gJyc7XG4gIC8vSG9sZCBpdGVtcyBzZWxlY3RlZCBmb3IgbXVsdGlwbGUgc2VsZWN0XG4gIG11bHRpcGxlRGVsZXRpb246QXJyYXk8YW55PiA9IFtdIDtcbiAgLy9Ib2xkIHN1YnNjcmlwdGlvbiBvZiBhcGkgY2FsbHMgd2hpY2ggY2FuIGJlIGNhbmNlZCBieSBjYWxsaW5nIGNhbmNlbExvYWRpbmcoKSBcbiAgbG9hZGVyOiBTdWJzY3JpcHRpb24gOyAgXG4gIC8vS2VlcCB0cmFjayBpZiBBUEkgY2FsbCBpcyBjb21wbGV0ZWRcbiAgbG9hZEZpbmlzaDogYm9vbGVhbiA9IGZhbHNlIDtcbiAgLy8gTGF6eSBsb2FkaW5nIGNvbmZpZ1xuICBwcml2YXRlIGxhenlsb2FkaW5nQ29uZmlnOiBhbnkgPSB7fSA7XG4gIHB1YmxpYyBwcm9jZXNzZWREYXRhOiBhbnkgPSB7fSA7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBodHRwOiBIdHRwKXtcbiAgICAgIFxuICB9XG5cbiAgcHVibGljIHNldExhenlsb2FkaW5nQ29uZmlnKGNvbmZpZzphbnkpe1xuICAgIHRoaXMubGF6eWxvYWRpbmdDb25maWcgPSBjb25maWcgO1xuICB9XG5cbiAgLy9HRVQgcmVxdWVzdCB0byB1c2VyJ3MgQVBJIHVybFxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSB1cmwgVXNlciBhcGkgcnVsXG4gICAqL1xuICBwdWJsaWMgZ2V0RGF0YSh1cmw6c3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+e1xuICAgICAgbGV0IGhlYWRlcnM6IEhlYWRlcnMgPSBuZXcgSGVhZGVycygpIDtcbiAgICAgIGhlYWRlcnMuYXBwZW5kKCdDb250ZW50LVR5cGUnLCdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnKSA7XG4gICAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwse2hlYWRlcnM6aGVhZGVyc30pLnBpcGUocmV0cnkoNSksbWFwKChyZXNwb25zZTogUmVzcG9uc2UpID0+IHJlc3BvbnNlLmpzb24oKSkpIDtcbiAgfVxuXG4gIC8vUG9zdCByZXF1ZXN0IGZvciBkYXRhIGV4cG9ydFxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSB1cmwgU2VydmljZSBhcGkgdXJsXG4gICAqIEBwYXJhbSBpZCBEYXRhdHlwZSBpZCB0byBleHBvcnRcbiAgICogQHBhcmFtIGRhdGEgRGF0YSB0byBleHBvcnRcbiAgICovXG4gIHB1YmxpYyBwb3N0RGF0YSh1cmw6c3RyaW5nLGlkOmFueSxkYXRhOnN0cmluZyk6IE9ic2VydmFibGU8YW55PntcbiAgICBsZXQgaGVhZGVyczogSGVhZGVycyA9IG5ldyBIZWFkZXJzKCkgO1xuICAgIGhlYWRlcnMuYXBwZW5kKCdDb250ZW50LVR5cGUnLCdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JykgO1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh1cmwraWQsZGF0YSx7aGVhZGVyczpoZWFkZXJzfSkucGlwZShtYXAoKHJlc3A6IFJlc3BvbnNlKSA9PiByZXNwLmpzb24oKSkpIDtcbiAgfVxuXG4gIC8qKlxuICAgKiBcbiAgICogQHBhcmFtIGRhdGFVcmwgU2V0IGRhdGF1cmxcbiAgICovXG4gIHB1YmxpYyBzZXREYXRhVXJsKGRhdGFVcmw6c3RyaW5nKTp2b2lke1xuICAgIHRoaXMuZGF0YVVybCA9IGRhdGFVcmwgO1xuICB9XG5cbiAgLy9HZXQgZGF0YSB1cmwgXG4gIHB1YmxpYyBnZXREYXRhVXJsKCk6c3RyaW5ne1xuICAgIHJldHVybiB0aGlzLmRhdGFVcmwgO1xuICB9XG5cbiAgLyoqXG4gICAqIFxuICAgKiBAcGFyYW0gZGF0YSBSZWdpc3RlciBuZXcgZGF0YSBmcm9tIHVzZXIgQVBJXG4gICAqL1xuICBwdWJsaWMgY2hhZ2VEYXRhVGFibGUoZGF0YTphbnkpe1xuICAgIHRoaXMuYmVoYXZpb3IubmV4dChkYXRhKSA7XG4gIH1cblxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSBudW1iZXJPZkxpc3QgVG90YWwgbnVtYmVyIG9mIGxpc3RcbiAgICogQHBhcmFtIGxpbWl0IFBhZ2luYXRpb24gbGltaXRcbiAgICovXG4gIHByaXZhdGUgY3JlYXRlUGFnaW5hdGlvbihudW1iZXJPZkxpc3Q6bnVtYmVyLGxpbWl0Om51bWJlcik6IEFycmF5PE9iamVjdD57XG4gICAgbGV0IG9iajogQXJyYXk8T2JqZWN0PiA9IFtdIDtcbiAgICBsZXQgY291bnRlcjogbnVtYmVyID0gMSA7XG4gICAgZm9yKGxldCBpPTA7aTxudW1iZXJPZkxpc3Q7aSs9bGltaXQpe1xuICAgICAgICBvYmoucHVzaCh7bGFiZWw6Y291bnRlcix2YWx1ZTppfSkgO1xuICAgICAgICBjb3VudGVyKysgO1xuICAgIH1cbiAgICBpZighdGhpcy5pc0xhenlMb2FkaW5nRW5hYmxlZCl7XG4gICAgICBvYmoucHVzaCh7IGxhYmVsOiAnQWxsJywgdmFsdWU6ICdhbGwnIH0pO1xuICAgIH1cbiAgICByZXR1cm4gb2JqIDtcbiAgfVxuXG4gIHB1YmxpYyBpc0xhenlMb2FkaW5nRW5hYmxlZCgpe1xuICAgIHJldHVybiB0aGlzLmxhenlsb2FkaW5nQ29uZmlnLmhhc093blByb3BlcnR5KFwiYXBpT2Zmc2V0S2V5XCIpICYmIHRoaXMubGF6eWxvYWRpbmdDb25maWcuYXBpT2Zmc2V0S2V5IDtcbiAgfVxuXG4gIC8vRXZlbnQgdG8gbG9hZCBkYXRhIGZyb20gdXNlcnMgYXBpXG4gIHB1YmxpYyBsb2FkRmx4RGF0YVRhYmxlRGF0YShkYXRhVXJsOnN0cmluZyxzZXRTZWxlY3RQYWdpbmF0aW9uOmJvb2xlYW49dHJ1ZSl7XG4gICAgdGhpcy5sb2FkRmluaXNoID0gZmFsc2UgO1xuICAgICAgdGhpcy5sb2FkZXIgPSB0aGlzLmdldERhdGEoZGF0YVVybCkuc3Vic2NyaWJlKChyZXNwb25zZURhdGEpID0+IHtcbiAgICAgICAgICB0cnl7XG4gICAgICAgICAgICAgIHRoaXMubXVsdGlwbGVEZWxldGlvbiA9IFtdIDtcbiAgICAgICAgICAgICAgdmFyIGRhdGEgPSAodGhpcy5kYXRhU3JjS2V5KSA/IHJlc3BvbnNlRGF0YVt0aGlzLmRhdGFTcmNLZXldIDogcmVzcG9uc2VEYXRhO1xuICAgICAgICAgICAgICB0aGlzLmNoYWdlRGF0YVRhYmxlKGRhdGEpIDtcbiAgICAgICAgICAgICAgaWYodGhpcy5pc0xhenlMb2FkaW5nRW5hYmxlZCgpKXsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdGhpcy50b3RhbEl0ZW1zID0gcmVzcG9uc2VEYXRhLnRvdGFsIDtcbiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgMSBwYWdpbmF0aW9uIG91dCBvZiB6ZXJvIHByb2JsZW0gMS8wICBpbnN0ZWFkIG9mIDAvMCBpZiBubyBkYXRhIGlzIGNvbW1pbmdcbiAgICAgICAgICAgICAgICBpZihkYXRhLmxlbmd0aD4wKXtcbiAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YU9mZnNldCA9IHRoaXMuZGF0YU9mZnNldCt0aGlzLmxpbWl0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgdGhpcy50b3RhbEl0ZW1zID0gZGF0YS5sZW5ndGggO1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YU9mZnNldCA9IDE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYoc2V0U2VsZWN0UGFnaW5hdGlvbil7XG4gICAgICAgICAgICAgICAgaWYodGhpcy5pc0xhenlMb2FkaW5nRW5hYmxlZCgpKXtcbiAgICAgICAgICAgICAgICAgIHRoaXMucGFnaW5hdGlvbiA9IHRoaXMuY3JlYXRlUGFnaW5hdGlvbihyZXNwb25zZURhdGEudG90YWwsIHRoaXMubGltaXQpO1xuICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgdGhpcy5wYWdpbmF0aW9uID0gdGhpcy5jcmVhdGVQYWdpbmF0aW9uKGRhdGEubGVuZ3RoLCB0aGlzLmxpbWl0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgdGhpcy5sb2FkRmluaXNoID0gdHJ1ZTtcbiAgICAgICAgICB9Y2F0Y2goZSl7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciBpbiByZWFkaW5nIGRhdGEgaW4gJyxlKSA7XG4gICAgICAgICAgfVxuICAgICAgfSwoZSA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkRmluaXNoID0gdHJ1ZSA7XG4gICAgICB9KSlcbiAgfVxuXG4gIC8vQ2FuY2VsIGFwaSBHRVQgcmVxdWVzdCB0byBhcGlcbiAgcHVibGljIGNhbmNlbExvYWRpbmcoKXtcbiAgICB0aGlzLmxvYWRlci51bnN1YnNjcmliZSgpIDtcbiAgfSAgXG5cbiAgLy9TZXQgc291cmNlIGtleSB0byByZWFkIGZyb20gcGF5bG9hZCByZXNwb25zZSBKU09OXG4gIHNldERhdGFTcmNLZXkoc3JjS2V5OnN0cmluZyk6dm9pZCB7XG4gICAgdGhpcy5kYXRhU3JjS2V5ID0gc3JjS2V5O1xuICB9XG5cbiAgZ2V0RGF0YUxlbmd0aCgpOiBQcm9taXNlPG51bWJlcj57XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPG51bWJlcj4oKHJlc29sdmUpID0+e1xuICAgICAgdGhpcy5mbHhEYXRhLnN1YnNjcmliZSgocmVzcCkgPT57XG4gICAgICAgIHJlc29sdmUocmVzcC5sZW5ndGgpIDtcbiAgICAgIH0sKGU9PntcbiAgICAgICAgcmVzb2x2ZSgwKSA7XG4gICAgICB9KSlcbiAgICB9KSA7XG4gIH1cbn0iXX0=